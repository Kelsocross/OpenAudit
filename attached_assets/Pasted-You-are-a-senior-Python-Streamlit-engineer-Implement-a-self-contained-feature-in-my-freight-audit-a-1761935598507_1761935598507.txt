You are a senior Python/Streamlit engineer. Implement a self-contained feature in my freight-audit app that auto-detects and manages FedEx “non-shipment miscellaneous charges” (e.g., Pay Type=Other4, blank Service, Delivery Date=1900-01-01, short/invalid tracking). Follow ALL requirements below exactly.

## Goals
1) Ingest FedEx export (.csv/.xlsx), normalize dates and fields, and treat "1900-01-01" Delivery as null.
2) Detect and label **Misc Non-Shipment** entries with a rule-score and confidence.
3) Categorize into buckets (Address Correction, Duties/Taxes, Paper Invoice Fee, Manual Adjustment, Misc Fee).
4) Provide a Streamlit page with KPIs, rollups, exception queue, and CSV downloads.
5) Include unit tests and a small sample file for quick verification.

## Tech/Deps
- Python 3.11+
- pandas, numpy, streamlit, openpyxl (for xlsx)
- No seaborn. Use Streamlit’s native charts or matplotlib if needed.

## Project changes
Create/modify the following:

### 1) requirements.txt
Append (ignore duplicates):
- pandas
- numpy
- streamlit
- openpyxl

### 2) audits/misc_nonship.py  (NEW)
Implement:
- `COLS` mapping:
  - "OPCO" -> opco
  - "Service Type" -> service_type
  - "Service Description" -> service_desc
  - "Pay Type" -> pay_type
  - "Shipment Date (mm/dd/yyyy)" -> ship_date
  - "Shipment Delivery Date (mm/dd/yyyy)" -> deliv_date
  - "Shipment Tracking Number" -> tracking
  - Optional: "Recipient Name" -> ship_to
  - Optional: "Charge Description" -> desc
  - Optional: "Charge Amount USD" -> amount
  - Optional: "Invoice Number" -> invoice
- `MISC_PAYTYPE_MAP`:
  - other4: "Misc Adjustment"
  - other3: "Misc Adjustment"
  - adjustment: "Manual Adjustment"
  - miscfee: "Misc Fee"
  - paperinvoice: "Paper Invoice Fee"
  - dutytax: "Duties/Taxes"
  - addresscorrection: "Address Correction"
- Helper functions:
  - `parse_date_safe(s)`: to_datetime; convert 1900-01-01 to NaT.
  - `is_valid_tracking(x)`: True if matches ^\d{12}$, ^\d{15}$, or ^\d{22}$.
- `normalize(df: pd.DataFrame) -> pd.DataFrame`:
  - Lowercase/sanitize text fields.
  - Create `ship_date_norm`, `deliv_date_norm`.
  - Feature flags:
    - `is_service_blank` (both service_type & service_desc empty)
    - `is_deliv_missing` (deliv_date_norm is NaT)
    - `is_paytype_misc` (pay_type in MISC_PAYTYPE_MAP keys)
    - `is_shipto_missing` (missing/blank)
    - `is_nonstandard_tracking` (!is_valid_tracking)
    - `is_express` (opco contains "express")
  - `misc_score`: sum of the above booleans.
  - Classification: `is_misc_non_shipment = misc_score >= 3`  (make threshold a constant for easy tuning)
  - `misc_category`:
    - Prefer description keywords if available:
      - contains "address correction" -> "Address Correction"
      - contains any of ["dutie", "vat", "tax"] -> "Duties/Taxes"
      - contains both "paper" and "invoice" -> "Paper Invoice Fee"
    - else map by pay_type via `MISC_PAYTYPE_MAP`, default "Misc Adjustment".
  - `misc_confidence` = misc_score / number_of_features (0..1, round 2)
  - Ensure `amount_num` numeric if present; else 0.0.
- `build_misc_views(df) -> (queue, by_cat, by_month, summary)`:
  - `queue` = df[df.is_misc_non_shipment]
  - `by_cat` = sum amount by misc_category
  - `by_month` = sum amount by ship_date month (YYYY-MM)
  - `summary` dict: count_misc, sum_misc, avg_misc

Export: COLS, MISC_PAYTYPE_MAP, normalize, build_misc_views.

### 3) pages/03_Misc_Charges.py  (NEW Streamlit page)
- File uploader (.csv/.xlsx)
- On upload:
  - Load via pandas (read_excel if xlsx else read_csv).
  - Call normalize -> dfn
  - queue, by_cat, by_month, summary = build_misc_views(dfn)
- Show KPIs with st.metric:
  - Misc charges (count), Total $, Avg $
- Show rollups:
  - "By Category" (st.dataframe)
  - "By Month" (st.line_chart or st.bar_chart with month vs amount)
- Show **Exceptions Queue** (st.dataframe) with the most helpful columns:
  - OPCO, Pay Type, Shipment Date, Shipment Delivery Date,
    Tracking, misc_category, misc_confidence, amount_num, Invoice Number (if exists)
- Add 3 download buttons for CSVs:
  - exceptions queue, by category, by month
- Add a triage helper expander with instructions:
  - “Open invoice in FedEx Billing Online; capture line description; set Disposition = [Dispute, Rebill, Accept]; Owner; Due Date.”
- Add sidebar controls:
  - Confidence threshold slider (default 0.5) to filter queue
  - Category multiselect to filter
- Persist user filters in session_state.

### 4) tests/test_misc_nonship.py  (NEW)
- Create a minimal DataFrame with the exact case:
  - OPCO="Express", Service Type="", Service Description="", Pay Type="Other4",
    Shipment Date="2025-09-16", Shipment Delivery Date="1900-01-01",
    Shipment Tracking Number="5416334", Charge Amount USD=42.00
- Assert:
  - normalize -> row.is_misc_non_shipment is True
  - misc_category in {"Misc Adjustment","Address Correction","Paper Invoice Fee","Duties/Taxes"}
  - misc_confidence between 0.4 and 1.0
- Add one valid-shipment control row (proper service, valid tracking, real delivery date) and assert it is NOT misc.

### 5) sample_data/fedex_misc_sample.xlsx  (NEW)
- Include 3 rows:
  1) The $42 “Other4” case (non-shipment)
  2) A valid shipment row
  3) A duties/tax adjustment example (desc contains “VAT”)
- Ensure columns match COLS.

### 6) Makefile (optional but preferred)
Targets:
- `setup`: pip install -r requirements.txt
- `test`: python -m pytest -q
- `run`: streamlit run pages/03_Misc_Charges.py

## Success criteria
- Running `streamlit run pages/03_Misc_Charges.py` loads, accepts upload of sample_data/fedex_misc_sample.xlsx, and shows:
  - KPIs with count/total/avg
  - “By Category” and “By Month” tables/charts
  - Exceptions Queue with the $42 example flagged as Misc with confidence >= 0.5
  - Download buttons produce valid CSV files
- Tests in tests/test_misc_nonship.py pass.

## Notes
- Keep functions pure and well-documented. Avoid app-wide side effects.
- Do not break existing pages; this is an additive feature.
- Write clean, readable code with type hints where reasonable.
- After completion, print short usage instructions (how to run, where to click).
